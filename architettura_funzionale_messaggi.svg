<svg width="1200" height="800" viewBox="0 0 1200 800" fill="none" xmlns="http://www.w3.org/2000/svg">
  <!-- Sfondo -->
  <rect width="1200" height="800" rx="20" fill="#f8fafc"/>
  
  <!-- TITOLO -->
  <text x="600" y="40" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="#1e293b" text-anchor="middle">ARCHITETTURA FUNZIONALE E FLUSSO DEI MESSAGGI (v6.12)</text>
  <text x="600" y="65" font-family="Arial, sans-serif" font-size="14" fill="#64748b" text-anchor="middle">Relazioni tra moduli e metodi di chiamata</text>

  <!-- MODULO FRONTEND (SINISTRA) -->
  <rect x="50" y="150" width="250" height="500" rx="15" fill="#f0fdf4" stroke="#10b981" stroke-width="3"/>
  <text x="175" y="190" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#064e3b" text-anchor="middle">STREAMLIT UI</text>
  <rect x="70" y="220" width="210" height="40" rx="5" fill="white" stroke="#10b981"/>
  <text x="175" y="245" font-family="Arial, sans-serif" font-size="12" fill="#065f46" text-anchor="middle">Auth &amp; Session State</text>
  <rect x="70" y="280" width="210" height="40" rx="5" fill="white" stroke="#10b981"/>
  <text x="175" y="305" font-family="Arial, sans-serif" font-size="12" fill="#065f46" text-anchor="middle">Multi-file Uploader</text>
  <rect x="70" y="340" width="210" height="40" rx="5" fill="white" stroke="#10b981"/>
  <text x="175" y="365" font-family="Arial, sans-serif" font-size="12" fill="#065f46" text-anchor="middle">Search Bar &amp; History</text>

  <!-- MODULO LOGICA / AGENTE (CENTRO) -->
  <rect x="450" y="150" width="300" height="500" rx="15" fill="#eff6ff" stroke="#3b82f6" stroke-width="3"/>
  <text x="600" y="190" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#1e40af" text-anchor="middle">AGENTE IA (ORCHESTRATOR)</text>
  
  <circle cx="600" cy="300" r="60" fill="white" stroke="#3b82f6" stroke-width="2"/>
  <text x="600" y="295" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#1e40af" text-anchor="middle">LLM</text>
  <text x="600" y="315" font-family="Arial, sans-serif" font-size="10" fill="#1e40af" text-anchor="middle">Llama 3.1 8B</text>

  <rect x="475" y="400" width="250" height="80" rx="10" fill="white" stroke="#3b82f6"/>
  <text x="600" y="430" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#1e40af" text-anchor="middle">REASONING ENGINE</text>
  <text x="600" y="455" font-family="Arial, sans-serif" font-size="11" fill="#64748b" text-anchor="middle">Expansion &amp; Reflection</text>

  <!-- MODULI STORAGE (DESTRA) -->
  <g id="Databases">
    <!-- PostgreSQL -->
    <rect x="900" y="150" width="250" height="100" rx="10" fill="#f1f5f9" stroke="#334155" stroke-width="2"/>
    <text x="1025" y="180" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">POSTGRESQL (SQL)</text>
    <text x="1025" y="205" font-family="Arial, sans-serif" font-size="11" fill="#475569" text-anchor="middle">Anagrafica, Hash, Login</text>

    <!-- Qdrant -->
    <rect x="900" y="280" width="250" height="100" rx="10" fill="#fff7ed" stroke="#c2410c" stroke-width="2"/>
    <text x="1025" y="310" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#c2410c" text-anchor="middle">QDRANT (Vector)</text>
    <text x="1025" y="335" font-family="Arial, sans-serif" font-size="11" fill="#9a3412" text-anchor="middle">Skill, Vettori, Metadati</text>

    <!-- Redis -->
    <rect x="900" y="410" width="250" height="100" rx="10" fill="#fef2f2" stroke="#dc2626" stroke-width="2"/>
    <text x="1025" y="440" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#991b1b" text-anchor="middle">REDIS (Cache)</text>
    <text x="1025" y="465" font-family="Arial, sans-serif" font-size="11" fill="#b91c1c" text-anchor="middle">Cronologia, Sessioni</text>

    <!-- File System -->
    <rect x="900" y="540" width="250" height="100" rx="10" fill="#f8fafc" stroke="#64748b" stroke-width="2"/>
    <text x="1025" y="570" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#475569" text-anchor="middle">LOCAL UPLOADS</text>
    <text x="1025" y="595" font-family="Arial, sans-serif" font-size="11" fill="#64748b" text-anchor="middle">File PDF/TXT Originali</text>
  </g>

  <!-- RELAZIONI E FUNZIONI (FRECCE) -->
  
  <!-- UI <-> SQL -->
  <path d="M300 200 H900" stroke="#334155" stroke-width="2" marker-end="url(#arrow-sql)"/>
  <text x="600" y="195" font-family="Courier New" font-size="12" fill="#334155" text-anchor="middle" font-weight="bold">cur.execute("SELECT/INSERT")</text>

  <!-- UI <-> REDIS -->
  <path d="M300 460 H900" stroke="#dc2626" stroke-width="2" marker-end="url(#arrow-redis)"/>
  <text x="600" y="455" font-family="Courier New" font-size="12" fill="#dc2626" text-anchor="middle" font-weight="bold">redis.lpush() / lrange()</text>

  <!-- UI <-> QDRANT -->
  <path d="M300 330 H900" stroke="#c2410c" stroke-width="2" marker-end="url(#arrow-vector)"/>
  <text x="600" y="325" font-family="Courier New" font-size="12" fill="#c2410c" text-anchor="middle" font-weight="bold">vector_store.similarity_search() / add_documents()</text>

  <!-- UI <-> LLM -->
  <path d="M300 380 H450" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrow-ai)"/>
  <text x="375" y="375" font-family="Courier New" font-size="12" fill="#1e40af" text-anchor="middle" font-weight="bold">llm.invoke()</text>
  <path d="M450 420 H300" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrow-ai)"/>
  <text x="375" y="415" font-family="Courier New" font-size="12" fill="#1e40af" text-anchor="middle" font-weight="bold">llm.stream()</text>

  <!-- LLM <-> STORAGE (Il contesto arricchito) -->
  <path d="M750 330 L900 330" stroke="#3b82f6" stroke-width="2" stroke-dasharray="4 4"/>
  <path d="M750 200 L900 200" stroke="#3b82f6" stroke-width="2" stroke-dasharray="4 4"/>
  <text x="825" y="280" font-family="Arial, sans-serif" font-size="11" fill="#3b82f6" text-anchor="middle" font-style="italic">Context</text>
  <text x="825" y="295" font-family="Arial, sans-serif" font-size="11" fill="#3b82f6" text-anchor="middle" font-style="italic">Injection</text>

  <!-- DEFINIZIONI FRECCE -->
  <defs>
    <marker id="arrow-sql" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#334155" /></marker>
    <marker id="arrow-vector" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#c2410c" /></marker>
    <marker id="arrow-redis" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#dc2626" /></marker>
    <marker id="arrow-ai" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" /></marker>
  </defs>
</svg>
